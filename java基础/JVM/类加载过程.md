# 类加载过程 #

系统加载Class类型的文件主要三步:**加载->链接->初始化**.连接过程又可分为三步:**验证->准备->解析.**  

## 加载 ##  

类加载的第一步主要完成下面3件事:  

1. 通过全类名获取定义此类的二进制字节流  
2. 将字节流所代表的静态存储结构转换为方法区的运行时数据结构
3. 在内存中生成一个代表该类的Class对象,作为方法区这些数据的访问入口  

**一个非数组类的加载阶段是可控性最强的阶段,这一步我们可以去完成还可以自定义类加载器去控制字节流的获取方式(重写一个类加载器的`loadclass()`方法).数组类型不通过类加载创建,它由Java虚拟机直接创建.**   

加载阶段和链接阶段的部分内容是交叉进行的,加载阶段尚未结束,链接阶段可能已经开始了.  

## 验证 ## 

文件格式验证 -> 元数据验证 -> 字节码验证 -> 符号引用验证  

## 准备 ## 

**准备阶段是正式为类变量分配内存并设置类变量初始值的阶段**,这些内存都将在方法区中分配.对于该阶段有以下几点需要注意:  

1. 这时候进行的内存分配的仅包括类变量(static), 而不包括实例变量,实例变量会在对象实例化时随着对象一块分配在Java中  
2. 初始值是指数据类型默认的零值  

## 解析 ##  

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程.解析动作主要针对类或者接口,字段,类方法,接口方法,方法类型,方法句柄和调用限定符7类符号引用进行.  
符号引用就是一组符号来描述目标,可以是任何字面量.**直接引用**就是直接指向目标的指针,相对偏移量或者一个间接定位到目标的句柄.在程序实际运行过程中,只有符号引用是不够的.  
综上,解析阶段就是虚拟机将常量池内的符号引用替换为直接引用的过程,也就是得到类或者字段,方法在内存中的指针或者偏移量.  

## 初始化 ##  

初始化阶段是执行类构造器`<clinit>()`方法的过程,它是带锁线程安全  
对于初始化阶段,虚拟机严格规定了有且只有5种情况下,必须堆类进行初始化
